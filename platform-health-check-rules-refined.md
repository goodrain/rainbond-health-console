# Rainbond 平台稳定性监控规则

**说明：本文档只包含影响平台稳定性的严重故障监控，不包括平台上运行的用户服务。**

## 一、平台依赖基础设施（P0 - 致命）

**影响：平台核心功能不可用**

### 1.1 数据库

| 监控指标 | 告警条件 | 说明 |
|---------|---------|------|
| 内部数据库连接 | mysql_up == 0 | 数据库不可达 |
| 外部数据库连接 | mysql_up == 0 | 数据库不可达 |

### 1.2 Kubernetes 集群

| 监控指标 | 告警条件 | 说明 |
|---------|---------|------|
| API Server | apiserver 不可达 | K8s API 不可用 |
| CoreDNS | DNS 解析失败 | 集群内部域名解析异常 |
| Etcd | etcd 集群不可用 | K8s 存储后端故障 |
| 集群存储 | 外部存储类不可用 | 无法创建 PVC |
|            |                  |                      |

### 1.3 容器镜像仓库

| 监控指标 | 告警条件 | 说明 |
|---------|---------|------|
| 内部 Registry 连接 | 连接失败 | 镜像仓库不可达 |
| 外部 Registry 连接 | 连接失败 | 镜像仓库不可达 |

### 1.4 对象存储（MinIO/S3）

| 监控指标 | 告警条件 | 说明 |
|---------|---------|------|
| 存储服务 | minio_up == 0 | 对象存储不可用 |

---

## 二、平台关键资源（P1 - 严重）

**影响：平台功能受限或即将不可用**

### 2.1 磁盘空间

| 监控项 | 告警条件 | 说明 |
|-------|---------|------|
| /grdata 目录 | 剩余空间 < 10% | 构建/日志目录空间不足 |
| 节点磁盘 | 使用率 > 80% | 节点磁盘空间紧张 |
| 外部存储 | 存储卷已满 | 外部存储空间耗尽 |

### 2.2 计算资源

| 监控项 | 告警条件 | 说明 |
|-------|---------|------|
| 集群内存 | 可用内存 < 10% | 集群内存即将耗尽 |
| 集群 CPU | 可用 CPU < 10% | 集群 CPU 资源即将耗尽 |

### 2.3 节点状态

| 监控项           | 告警条件 | 说明 |
|---------------|---------|------|
| 节点可用性         | 节点状态为 NotReady | 节点宕机或不可用 |
|            |                     |                  |
| 节点高负载 |  |  |





本次 62 节点业务 Pod 出现域名无法解析的根因是 节点间 Flannel 网络状态不一致导致的 CNI 半失效。
在 61 节点重启的过程中，集群网络（Flannel VXLAN）会重新分配并广播节点的子网、VTEP 信息和路由表。该过程需要所有节点通过与 apiserver 的 watch 长连接实时同步更新。然而，62 节点在 61 重启的关键时间点发生了 flannel 与 apiserver 的 watch 连接中断（日志中出现 http2: client connection lost），导致该节点随后错过了集群网络路由与 VXLAN 信息的更新事件。由于路由信息未同步成功，62 节点本地的 VXLAN、路由表及 iptables NAT 规则与实际集群状态不一致，进而造成访问 ClusterIP（特别是 CoreDNS 服务）失败，表现为Pod 内无法解析域名、无法连接 DNS。

该状态属于典型的 Flannel 网络同步异常，不会自动自愈，需通过重启 rke2-agent 或 flannel 组件重新加载网络配置。重启后，62 节点成功重新建立 watch 并同步所有网络数据，因此 DNS 功能恢复正常。
